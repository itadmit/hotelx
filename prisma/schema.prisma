// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  emailVerified DateTime?
  image         String?
  role          Role      @default(STAFF)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  hotelId       String?
  hotel         Hotel?    @relation(fields: [hotelId], references: [id])
  assignedRequests Request[]
  assignedComplaints Complaint[]
}

model Hotel {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  logo          String?
  coverImage    String?   // Cover image for guest app
  primaryColor  String?   @default("#2563eb")
  wifiName      String?   // WiFi network name for guest access
  language      String?   @default("en") // Default language: en, bg, de, fr, it
  currency      String?   @default("USD") // Default currency: USD, EUR, GBP, ILS, JPY, BGN
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  users         User[]
  rooms         Room[]
  services      Service[]
  requests      Request[]
  categories    Category[]
  translations  Translation[]
  complaints    Complaint[]
  reviews       Review[]
  guestSessions GuestSession[]
}

model Room {
  id            String    @id @default(cuid())
  number        String
  code          String    @unique // Unique code for QR (e.g. random 6 chars)
  type          String?   // Suite, Single, Double
  status        RoomStatus @default(ACTIVE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  hotelId       String
  hotel         Hotel     @relation(fields: [hotelId], references: [id])
  requests      Request[]
  complaints    Complaint[]
  reviews       Review[]

  @@unique([hotelId, number])
}

model Category {
  id            String    @id @default(cuid())
  name          String
  customName    String?   // Custom name override for hotel
  slug          String
  icon          String?   // Lucide icon name
  emoji         String?   // Custom emoji for category
  bgImage       String?   // Background image for category
  isActive      Boolean   @default(true) // Hotel can enable/disable categories
  order         Int       @default(0)
  
  // Sub-categories support
  parentId      String?   // Parent category ID for sub-categories
  parent        Category? @relation("SubCategories", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subCategories Category[] @relation("SubCategories")
  
  // Relations
  hotelId       String
  hotel         Hotel     @relation(fields: [hotelId], references: [id])
  services      Service[]

  @@unique([hotelId, slug])
}

model Service {
  id            String    @id @default(cuid())
  name          String
  slug          String?   // URL-friendly identifier
  description   String?
  price         Decimal?  @db.Decimal(10, 2)
  currency      String    @default("USD")
  estimatedTime String?   // e.g. "20 min"
  image         String?
  isActive      Boolean   @default(true)
  
  // Tags
  isRecommended Boolean   @default(false) // Recommended
  isNew         Boolean   @default(false) // New
  isHot         Boolean   @default(false) // Hot/Popular
  isVegetarian  Boolean   @default(false) // Vegetarian
  isVegan       Boolean   @default(false) // Vegan
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  hotelId       String
  hotel         Hotel     @relation(fields: [hotelId], references: [id])
  categoryId    String
  category      Category  @relation(fields: [categoryId], references: [id])
  requests      Request[]
  customFields  ServiceCustomField[]
  
  @@unique([hotelId, slug])
  @@index([slug])
}

model Translation {
  id          String   @id @default(cuid())
  entityType  String   // "Category" or "Service"
  entityId    String   // ID of Category or Service
  language    String   // "en", "he", "ar", etc.
  field       String   // "name" or "description"
  value       String   // Translated value
  hotelId     String   // For easier querying
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  hotel       Hotel    @relation(fields: [hotelId], references: [id])

  @@unique([entityType, entityId, language, field])
  @@index([entityType, entityId])
  @@index([hotelId])
}

model Request {
  id            String    @id @default(cuid())
  status        RequestStatus @default(NEW)
  quantity      Int       @default(1) // Quantity of items ordered
  customFieldsData Json?   // Store selected custom field values as JSON
  notes         String?
  guestName     String?   // Full name of the guest placing the order
  guestPhone    String?   // Guest phone number
  guestEmail    String?   // Guest email
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  completedAt   DateTime?

  // Relations
  hotelId       String
  hotel         Hotel     @relation(fields: [hotelId], references: [id])
  roomId        String
  room          Room      @relation(fields: [roomId], references: [id])
  serviceId     String
  service       Service   @relation(fields: [serviceId], references: [id])
  assigneeId    String?
  assignee      User?     @relation(fields: [assigneeId], references: [id])
  complaints    Complaint[]
  reviews       Review[]
}

model ServiceCustomField {
  id          String   @id @default(cuid())
  label       String   // e.g. "Egg Style", "Pillow Type"
  fieldType   CustomFieldType // RADIO, CHECKBOX, SELECT
  options     Json     // Array of options: ["Soft", "Medium", "Hard"]
  isRequired  Boolean  @default(false)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  serviceId   String
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
}

enum Role {
  ADMIN
  MANAGER
  STAFF
}

enum RoomStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
}

enum RequestStatus {
  NEW
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CustomFieldType {
  RADIO      // Single choice
  CHECKBOX   // Multiple choice
  SELECT     // Dropdown single choice
}

model Complaint {
  id            String    @id @default(cuid())
  type          ComplaintType
  description   String
  status        ComplaintStatus @default(NEW)
  priority      ComplaintPriority @default(MEDIUM)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  resolvedAt    DateTime?

  // Relations
  hotelId       String
  hotel         Hotel     @relation(fields: [hotelId], references: [id])
  roomId        String
  room          Room      @relation(fields: [roomId], references: [id])
  requestId     String?   // Optional - if related to a specific request
  request       Request?  @relation(fields: [requestId], references: [id])
  assigneeId    String?   // Staff member handling the complaint
  assignee      User?     @relation(fields: [assigneeId], references: [id])

  @@index([hotelId])
  @@index([status])
  @@index([priority])
  @@index([roomId])
}

model Review {
  id            String    @id @default(cuid())
  rating        Int       // 1-5 stars
  comment       String?
  category      ReviewCategory
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  hotelId       String
  hotel         Hotel     @relation(fields: [hotelId], references: [id])
  roomId        String
  room          Room      @relation(fields: [roomId], references: [id])
  requestId     String    // Always linked to a completed request
  request       Request   @relation(fields: [requestId], references: [id])

  @@index([hotelId])
  @@index([rating])
  @@index([requestId])
}

enum ComplaintType {
  ORDER_ISSUE      // Problem with order (food quality, wrong item, etc.)
  ROOM_ISSUE       // Room problems (AC, cleanliness, amenities)
  NOISE            // Noise complaints
  CLEANLINESS      // Cleanliness issues
  STAFF            // Staff behavior issues
  DELAY            // Service delays
  OTHER            // Other complaints
}

enum ComplaintStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CANCELLED
}

enum ComplaintPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ReviewCategory {
  QUALITY          // Food/service quality
  SPEED            // Delivery speed
  STAFF            // Staff friendliness
  VALUE            // Value for money
  OVERALL          // Overall experience
}

model GuestSession {
  id            String    @id @default(cuid())
  hotelId       String
  hotel         Hotel     @relation(fields: [hotelId], references: [id])
  roomCode      String
  phoneNumber   String    // Unique identifier for guest
  fullName      String
  email         String?
  createdAt     DateTime  @default(now())
  lastActive    DateTime  @updatedAt
  expiresAt     DateTime  // 7 days from creation or 24h if guest mode
  isGuestMode   Boolean   @default(false) // true = 24h expiry, false = 7 days
  
  @@unique([hotelId, roomCode, phoneNumber])
  @@index([phoneNumber])
  @@index([expiresAt])
  @@index([hotelId, roomCode])
}
